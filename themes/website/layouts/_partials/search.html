<div id="search">
    <input
        type="text"
        id="search-input"
        placeholder="What are you looking for?"
    />
    <a href="#">Enter &#x23CE;</a>
    <div id="search-results"></div>
</div>
<script>
    (function () {
        let pagefind;
        let searchPending = false;

        async function init() {
            if (pagefind) return;
            pagefind = await import("/pagefind/pagefind.js");
            await pagefind.init();
        }

        function escapeHtml(text) {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
        }

        async function doSearch() {
            if (searchPending) return;
            searchPending = true;

            try {
                await init();
                const query = document.getElementById("search-input").value;
                const results = await pagefind.search(query);
                const list = document.getElementById("search-results");

                const items = [];
                for (const result of results.results) {
                    console.log("Score:", result.score);
                    if (result.score < 0.5) continue;
                    const data = await result.data();
                    items.push(
                        '<h2><a href="' +
                            escapeHtml(data.url) +
                            '">' +
                            escapeHtml(data.meta.title) +
                            "</a></h2>",
                    );
                }

                if (items.length > 0) {
                    list.innerHTML = "<hr><h1>Results</h1>" + items.join("");
                } else if (query.length > 0) {
                    list.innerHTML = "<hr><p>No results found.</p>";
                } else {
                    list.innerHTML = "";
                }
            } catch (e) {
                console.error("Search failed:", e);
                document.getElementById("search-results").innerHTML =
                    "<hr><p>Search unavailable.</p>";
            } finally {
                searchPending = false;
            }
        }

        document
            .getElementById("search-input")
            .addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    doSearch();
                }
            });

        document
            .querySelector("#search > a")
            .addEventListener("click", function (e) {
                e.preventDefault();
                doSearch();
            });
    })();
</script>
