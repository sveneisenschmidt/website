name: Deploy

on:
  push:
    branches:
      - main
  schedule:
    # Every 30 minutes
    - cron: "0,30 * * * *"

jobs:
  deploy:
    if: github.actor == 'sveneisenschmidt'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "latest"
          extended: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Show build time and scheduled posts
        run: |
          echo "Current time (Hugo's perspective): $(date -u '+%Y-%m-%dT%H:%M:%S+00:00')"
          echo ""
          echo "Scheduled posts (future):"
          hugo list future || echo "No future posts"
          echo ""

      - name: Build
        run: |
          hugo --minify
          npx pagefind --site public --glob 'posts/*/**/*.html'
          rm -f public/pagefind/pagefind-ui.* public/pagefind/pagefind-modular-ui.* public/pagefind/pagefind-highlight.js

      - name: Deploy via SSH
        uses: easingthemes/ssh-deploy@v4
        with:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.DEPLOY_HOST }}
          REMOTE_USER: ${{ secrets.DEPLOY_USER }}
          TARGET: ${{ secrets.DEPLOY_PATH }}
          SOURCE: public/

      - name: Submit to IndexNow
        run: |
          INDEXNOW_KEY=$(basename static/*-*-*-*-*.txt .txt)
          URLS=$(curl -s https://sven.eisenschmidt.website/sitemap.xml | grep -oE 'https://sven\.eisenschmidt\.website[^<]+')
          URL_LIST=$(echo "$URLS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "Submitting $(echo "$URLS" | wc -l | tr -d ' ') URLs to IndexNow..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://api.indexnow.org/indexnow" \
            -H "Content-Type: application/json" \
            -d "{\"host\":\"sven.eisenschmidt.website\",\"key\":\"$INDEXNOW_KEY\",\"urlList\":$URL_LIST}")
          echo "IndexNow response: $HTTP_STATUS"
          if [ "$HTTP_STATUS" -ge 400 ]; then exit 1; fi
